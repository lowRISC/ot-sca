pr:
  branches:
    include:
    - "*"

jobs:
- job: aes_sca_capture_cw310
  displayName: "Capture AES SCA traces (CW310)"
  timeoutInMinutes: 30
  pool:
    name: FPGA SCA
    demands: BOARD -equals cw310
  steps:
  - checkout: self
  - bash: |
      python3 -m pip install --user -r python-requirements.txt
    displayName: "Install python dependencies"
  - bash: |
      apt update
      apt install git-lfs
    displayName: "Install system dependencies"
  - bash: |
      git-lfs pull
    displayName: "Pull LFS binaries"
  - bash: |
      set -e
      pushd ci
      mkdir -p projects
      ../capture/capture_aes.py -c cfg/ci_aes_sca_fvsr_cw310_simpleserial.yaml -p projects/aes_sca_fvsr_cw310
      popd
    displayName: "Capture AES FVSR traces (simpleserial)"
  - publish: ./ci/projects/aes_sca_fvsr_cw310.html
    artifact: traces_aes_fvsr
    displayName: "Upload AES FVSR traces (simpleserial)"
  - bash: |
      set -e
      pushd ci
      ../analysis/tvla.py --cfg-file cfg/ci_tvla_cfg_aes_specific_byte0_rnd0_simpleserial.yaml run-tvla
      popd
    displayName: "Perform TVLA on AES FVSR traces (simpleserial)"
    continueOnError: True
  - publish: ./ci/tmp/figures
    artifact: tvla_figure_simpleserial
    displayName: "Upload figure of AES TVLA (simpleserial)."  
  - bash: |
      set -e
      pushd ci
      mkdir -p projects
      ../capture/capture_aes.py -c cfg/ci_aes_sca_random_cw310_simpleserial.yaml -p projects/aes_sca_random_cw310
      popd
    displayName: "Capture AES Random traces (simpleserial)"
  - publish: ./ci/projects/aes_sca_random_cw310.html
    artifact: traces_aes_random_key
    displayName: "Upload AES Random traces (simpleserial)"
  - bash: |
      set -e
      pushd ci
      ./ci_trace_check/ci_compare_aes_traces.py -f ./projects/aes_sca_random_cw310 -g ./ci_trace_check/golden_traces/aes_sca_random_golden_cw310 -c 0.8
      popd
    displayName: "Compare AES Random traces against golden trace"
  - bash: |
      set -e
      pushd ci
      mkdir -p projects
      ../capture/capture_aes.py -c cfg/ci_aes_sca_fvsr_cw310_ujson.yaml -p projects/aes_sca_fvsr_cw310_ujson
      popd
    displayName: "Capture AES FVSR traces (ujson)"
  - publish: ./ci/projects/aes_sca_fvsr_cw310_ujson.html
    artifact: traces_aes_fvsr_ujson
    displayName: "Upload AES FVSR traces (ujson)"
  - bash: |
      set -e
      pushd ci
      ../analysis/tvla.py --cfg-file cfg/ci_tvla_cfg_aes_specific_byte0_rnd0_ujson.yaml run-tvla
      popd
    displayName: "Perform TVLA on AES FVSR traces (uJSON)"
    continueOnError: True
  - publish: ./ci/tmp/figures
    artifact: tvla_figure_ujson
    displayName: "Upload figure of AES TVLA (uJSON)." 
  - bash: |
      set -e
      pushd ci
      mkdir -p projects
      ../capture/capture_aes.py -c cfg/ci_aes_sca_random_cw310_ujson.yaml -p projects/aes_sca_random_cw310_ujson
      popd
    displayName: "Capture AES Random traces (ujson)"
  - publish: ./ci/projects/aes_sca_random_cw310_ujson.html
    artifact: traces_aes_random_key_ujson
    displayName: "Upload AES Random traces (ujson)"
