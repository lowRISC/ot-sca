pr:
  branches:
    include:
    - "*"

jobs:
- job: sca_capture_cw310
  displayName: "Capture SCA traces (CW310)"
  timeoutInMinutes: 30
  pool:
    name: FPGA SCA
    demands: BOARD -equals cw310
  steps:
  - checkout: self
  - bash: |
      python3 -m pip install --user -r python-requirements.txt
    displayName: "Install python dependencies"
  - bash: |
      apt update
      apt install git-lfs
    displayName: "Install system dependencies"
  - bash: |
      git-lfs pull
    displayName: "Pull LFS binaries"
  - bash: |
      pushd ci
      ./ci_capture_aes_fvsr.sh
      popd
    displayName: "Capture traces"
  - publish: ./ci/ci_projects/opentitan_simple_aes_data/
    artifact: traces
    displayName: "Upload traces"
  - bash: |
      set -e
      pushd ci
      ./ci_check_aes_traces.sh
      ./ci_trace_check/ci_compare_aes_traces.py -f ./ci_projects/opentitan_simple_aes.cwp -g ./ci_trace_check/golden_traces/aes_128_ecb_static_cw310.zip -c 0.8
      popd
    displayName: "Compare captured AES trace against golden trace"
    continueOnError: True
  - publish: ./ci/tmp/
    artifact: plot_traces_aes
    displayName: "Upload plot of captured AES traces."
  - publish: ./ci/ci_projects/opentitan_simple_aes.zip
    artifact: project_traces_aes
    displayName: "Upload project of captured AES traces."
  - bash: |
      set -e
      pushd ci
      mkdir -p projects
      ../cw/simple_capture_aes_sca.py cfg/ci_simple_capture_aes_sca.yaml
      ../cw/tvla.py --cfg-file cfg/ci_tvla_cfg_aes_specific_byte0_rnd0.yaml run-tvla
      popd
    displayName: "Check AES TVLA"
    continueOnError: True
  - publish: ./ci/tmp/figures
    artifact: tvla_figure
    displayName: "Upload figure of AES TVLA."
  - bash: |
      pushd ci
      ./ci_capture_all.sh
      popd
    displayName: "Check AES traces"
  - publish: ./ci/figures_tmp/
    artifact: cw310_figures
    displayName: "Upload figures of AES traces"

- job: sca_capture_cw305
  displayName: "Capture SCA traces (CW305)"
  timeoutInMinutes: 30
  pool:
    name: FPGA SCA
    demands: BOARD -equals cw305
  steps:
  - checkout: self
  - bash: |
      python3 -m pip install --user -r python-requirements.txt
    displayName: "Install python dependencies"
  - bash: |
      apt update
      apt install git-lfs
    displayName: "Install system dependencies"
  - bash: |
      git-lfs pull
    displayName: "Pull LFS binaries"
  - bash: |
      set -e
      cd cw
      ./capture.py --cfg-file capture_aes_cw305.yaml capture aes-random-batch --num-traces 1000 --force-program-bitstream
    displayName: "Capture traces"
